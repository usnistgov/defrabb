# CHANGELOG

## Milestone v0.018 2024-07-16

- XY GT fix - new script for GT fixing, more transparent as GT change documented in VCF header [issue #170].
- Using hap.py `--gender` option so XY chromosome genotypes are handled appropriately [36931fb2 and 9dc339c4].
- Adding hap.py extended csv to analysis.qmd [issue #41]
- Cleaning up codebase to better follow snakemake best practices [issue #176].

## Milestone v0.017 2024-07-08

- adding HG002 Q100 specific exclusions [issues #153 #154 and #158]
- adding exclusion for consecutive svs [issue #167]
- new approach to running pipeline (cloning repo and running in new directory) [issue #165]
- making exclusion code more robust [issues #164 and #166]
- debugging wrapper s3 and local release code [issues #168 and #174]
- adding unphased vcfs for evaluations
- adding truvari refine output to analysis report
- HG002 Q100 v1.1 draft benchmark [issue #175]

## Milestone v0.016 2024-05-23

- moving public facing version of repo to [https://github.com/usnistgov/defrabb](https://github.com/usnistgov/defrabb)
- adding manually generated HG002 Q100 specific exclusions [issues #153 #154 and #158]
- migrating unittests to pytest for consistency [issue #117]
- improving documentation and cleaning up resources.yaml
- incorporating quarto report for summary analysis of stats and output files [issue #19]
- additional callsets for evaluation: sawfish pacbio sv [issue #156], dragen v4.3.4 small variant and SVs
- initial HG008-Normal GRCh38 draft small variant and sv benchmark [issue #159]
- revised analysis report: incorporating exclusion intersection and improved var length plots
- Q100 benchmark updates: this new version just excludes additional regions from the small variant and SV benchmark bed files based on initial evaluations by your team and others, as well as potential errors in the assembly identified by the T2T-Q100 team. Specifically, in addition to regions excluded in the previous version, we exclude regions with:
	-	Differences between PAV and dipcall vcfs from Q100v1.0.1, using vcfeval for small variants and truvari refine for SVs. This excludes dipcall bugs (adjacent insertions and deletions in the alignments) as well as a few places where PAV and dipcall have large differences in their alignments of the assembly to the reference
	- Regions with inversions called by PAV, because dipcall represents these as SNVs, insertions, and/or deletions or has breaks in the alignments, and these generally can be called and aligned in different ways that arenâ€™t handled robustly by current benchmarking tools.
	- Dipcall bugs identified by searching dipcall alignments for adjacent insertions and deletions
	- A few manually identified dipcall bugs causing SV errors
	- The TSPY2 translocation region identified in our XY benchmark work, because it is unclear how to best represent variants in this region
	- Potential errors identified by aligning short and long reads to the Q100 assembly, calling variants, and curating a subset.
	- Potential mosaic and de novo variants identified by aligning 300x illumina and xx HiFi reads from HG002 and parents to each haplotype of the assembly and performing tumor/normal calling with parents as normal and HG002 as child

## Milestone v0.015 2024-02-15

Version released a bit later ... 2024-05-01

- version of codebase used to generate NIST_HG002_DraftBenchmark_defrabbV0.015-20240215
- fixing overlap exclusions - was incorrectly removing duplicated regions [issue #146]
- Converting reference sequence to uppercase in benchmark vcf [issue #144]
- Modify fix genotypes rule to be more specific about changes [issue #145]
- Added documentation for FTP release process [issue #142]

## Milestone v0.014 2024-02-09

- using git lfs and cleaning up history for github mirror
- fixing sentLRSV comparisons, adding revio and ultima callsets
- Fix issue with `workflow.source_path()` in params causing unintended rerunning of rules !138
- revising `run_defrabb` script for more robust usage
- getting vcf stats for benchmark variants only !109
- moved asm varcall vcf annotations to asm_varcalls dir to preventing duplicate annotation steps !108
- small variants no longer filtered as part of normalization step !107
- truvari refine now uses candidate refine regions bed generated by truvari bench !106
- including index of dipcall output vcf issue #130
- adding rule to merge regions in defined exclusions
- fixing flanks to exclude edges of dip.bed issue #128

## Milestone v0.013 2024-01-03

Bug fixes and modifications made while generating the Q100 HG002 benchmark.

- excluding VDJ from small and sv benchmark [issue #120](bbd-human-genomics/defrabb#120)
- numerous modifications to config files
- addressed issue with non-iupac bases in assembly as it was causing an error with the sample renaming step (d15c10fc855c2c46f42af3c00722cfd41864d6b2)
- debugging and fixing errors with wrapper script

## Milestone v0.012 2023-11-07

Numerous changes to repo aimed at improving usability and functionality.

- rewrote wrapper script in python for improved usability and easier development
- ensuring rules print logs to defined log files
- Using truvari anno trf to get widened SV coordinates instead of SVwiden for excluding SVs from the small variant benchmark regions. Created new TR databases for GRCh37, GRCh38, and CHM13 (<https://github.com/nate-d-olson/adotto-smk>)
- Fixed issue with truvari when base and comparison vcfs had different contig ids
- added bedtool summary to get chromosome level coverage stats for benchmark beds
- removed unplaced contigs and alts from benchmark regions
- copying config files to analysis run directory for clarity (file previously only in snakemake generated archive tarball)
- modified benchmark filenames to include benchmark type
- added ability to benchmark SVs with truvari refine
- updated README to more clearly document running defrabb and added output file descriptions
- now using v3.3 of GIAB stratifications (<https://ftp-trace.ncbi.nlm.nih.gov/ReferenceSamples/giab/release/genome-stratifications/v3.3/>)
- improving output benchmark vcf - changed sample name in vcf from dipcall default
- fixing issue where gaps were not appropriately excluded, gaps are now determined from the ref fasta file
- using updated version of GRCh38 with additional masked regions as described in [FixItFelix paper](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-023-02863-7).
- added VDJ to exclusions

## Milestone v0.011 2023-07-25

Most changes in this release were making the run_defrabb script more user friendly and fixing bugs encountered
making XY benchmark, comparison to Sentieon SV callsets, and benchmarks for v0.09 of T2T HG002 assembly

- improving usability of run_defrabb script, keep going, number of jobs, extra snakemake args
- updated usage documentation
- updated config to use v3.1 stratifications and ftp version of reference
- new benchmarks based on v0.9 of HG002 T2T assembly
- now including all homopolymers since able to evaluate with new high accuracy short read technologies

## Milestone v0.010 2022-09-21

- Fixing breaking changes introduced with v0.009.
- Will add back in downloading files functionality and simplifying api in future releases.

## Milestone v0.009 2022-07-20

- Modified analyses table api so that it is more intuitive
- Common script for downloading files including md5 checksum
- Using Paramspace for simplifying coding filenames (WIP Will want to clean-up final filenames)
- Added snippets for $137 and $138 with gt30 imperfect homopolymers and HiFiDV XY discrepancies with HiFiasm
- adding environment definition and local version for use with defrabb run script
- adding gawk to conda envs for improved reproducibility

Notes: API and file naming changes broke unit tests, tests will be updated for next release

## Milestone v0.008 2022-06-06

- incorporating truvari for evaluating structural variant benchmarks
- Using Truvari v3.2.0 with Bioconda package Issue #15

## Milestone v0.007 2022-05-09

- Draft benchmark sets for HG002 whole genome and XY only against CHM13v2
- Created wrapper script for running and archiving analysis runs.
- Added documentation for different stratification types
- Cleaned up issues related to running things on tibanna/ AWS
- Using Truvari v3.2.0 with Bioconda package Issue #15

## Milestone v0.006 2022-04-18

- updated framework to allow for GRCh37 and CHM13 as references (yet to vet GRCh37 however) changes by JM, including modifications to schema's and rules as well as adding appropriate reference dependencies.
- added chm13 exclusions set to resources.yml
- moved .genome files to resources/references/
- Fixed issue with padding for rule `intersect_SVs_and_homopolymers` when adding slop resulted in a negative starting position.
- Added initial set of python function and snakemake rule unit tests.

## Milestone v0.005 2022-03-25

- Using Snakemake version 7.3 addresses issue with local runs, removed groups for local rules
- Added documentation for running pipeline on AWS using Tibanna
- Adding analyses.tsv tables for additional framework runs

## Milestone v0.004 2022-03-03

- Revising test dataset for easier local development
- Adding basic report functionality
- Modifying logging and run scripts to help with debugging when running on AWS via Tibanna
- Added documentation for running defrabb on AWS via Tibanna
- Added rules for indexing dipcall output bams and draft benchmark vcfs
- Initial optimization of dipcall and happy resource compute requirements
- Added initial functionality for processing draft benchmark vcfs
- Revised and restructured resources.yml and schema for clearer documentation and easier use.
- Added analyses.tsv and updated resource config files for running framework on 44 HPRC genome and HG002 XY
- Cleaning up code and comments
- revised analyses schema for clarity, the API is still a work in progress, hope to make it more intuitive in future releases.
- Fixed exclusions; ensuring bed files are properly sorted, added slop to repeats before identifying regions to exclude, added config variables to clarify how exclusions are generated.

## Milestone v0.003 2022-01-28

- Version of pipeline used for generation and evaluation of the HG002 T2T assembly based draft benchmark set(HPRC-HG002-cur.20211005) with excluded regions.
- Modified framework into three components; asm-varcalls, benchmark, and evaluations.
- Repository clean-up, removing unused files and code, simplifying results and log paths
- Modified config files, analyses.tsv and resources.yml to better handle stratifications.
- Added genome and satellites excluded files to the repo and moved rules to generate files to snippets.
- Added directive for benchmarking for use in evaluating step resource requirements.
- Updated test dataset and config files for additional testing
- Revised documentation for running pipeline and added CONTRIBUTING.md with milestone release process.
- Snakemake formatting and linting using Snakemake tools
- Documentation for running pipeline

## Milestone v0.002 2022-01-20

- This version of the pipeline was used to perform initial analysis of benchmark set performance using
- Added functionality to excluded defined genomic regions of draft benchmark regions bed file
- Added utility scripts for running the pipeline on the CTCMS cluster
- New Chr21 test dataset for use in pipeline development
- Initial CI/CD setup
- Snakemake formatting and linting using Snakemake tools
- Documentation for running pipeline

## Milestone v0.001 2022-01-10

- First milestone
- added schema's for analyses table, config, and resource yamls
- Added ability to define analyses run with a metadata table for documenting framework runs
- Using pathlib for handling file paths
- Implementing small variant benchmarking with happy and structural variant benchmarking with Truvari
